# 反馈功能本地调试完整指南 🔧

## 🎯 问题说明

- ✅ 已修复 `netlify.toml` 配置错误
- ✅ 已增强后端日志输出
- ✅ 可以本地完整调试邮件发送功能

## 🚀 本地调试步骤

### 第 1 步：确认 .env 文件配置

```bash
# 查看 .env 文件
cat .env
```

确认内容：
```env
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_USER=你的163邮箱@163.com
SMTP_PASS=你的授权码
FEEDBACK_RECEIVER=你的163邮箱@163.com
```

### 第 2 步：启动 Netlify Dev

```bash
pnpm docs:dev:netlify
```

看到以下输出表示成功：
```
⬥ Injecting environment variable values for all scopes
⬥ Injected .env file env vars: SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, FEEDBACK_RECEIVER
◈ Setting up local dev server
◈ Starting Netlify Dev server
```

### 第 3 步：访问网站

浏览器会自动打开：
```
http://localhost:8888
```

如果没有自动打开，手动访问这个地址（注意是 8888 端口）

### 第 4 步：测试反馈功能

1. 点击右下角的反馈按钮
2. 填写测试内容（至少填写"反馈内容"）
3. 点击"发送留言"
4. **保持终端窗口打开，观察日志输出**

### 第 5 步：查看调试日志

终端会显示详细的日志：

```bash
📧 SMTP Configuration: {
  host: 'smtp.163.com',
  port: '465',
  user: 'xxx@163.com',
  receiver: 'xxx@163.com'
}
🔧 Creating SMTP transporter...
🔍 Verifying SMTP connection...
✅ SMTP connection verified successfully
📤 Sending email...
From: xxx@163.com
To: xxx@163.com
Subject: 📬 新反馈：测试 - 匿名用户
✅ Email sent successfully!
Message ID: <xxx@smtp.163.com>
Response: 250 Mail OK queued as xxx
```

## 📊 日志解读

### ✅ 成功的日志

| 日志 | 说明 |
|-----|------|
| `📧 SMTP Configuration` | 配置信息正确加载 |
| `✅ SMTP connection verified` | 连接验证成功 |
| `📤 Sending email...` | 开始发送邮件 |
| `✅ Email sent successfully` | 发送成功 |
| `250 Mail OK queued` | 邮件服务器确认接收 |

### ❌ 常见错误日志

#### 错误 1：Missing required environment variables
```bash
❌ Missing required environment variables: {
  SMTP_HOST: false,
  SMTP_USER: false,
  SMTP_PASS: false,
  FEEDBACK_RECEIVER: false
}
```

**原因**：`.env` 文件不存在或配置不正确

**解决**：
1. 确认项目根目录有 `.env` 文件
2. 检查文件内容格式
3. 重启 `pnpm docs:dev:netlify`

---

#### 错误 2：SMTP authentication failed
```bash
❌ SMTP verification failed: Invalid login: 535 authentication failed
💡 提示: 确认使用的是授权码，不是登录密码
```

**原因**：
- 使用了登录密码，而不是授权码
- 授权码输入错误

**解决**：
1. 登录 163 邮箱
2. 进入 设置 → POP3/SMTP/IMAP
3. 重新生成授权码
4. 更新 `.env` 文件中的 `SMTP_PASS`
5. 重启服务

---

#### 错误 3：ENOTFOUND smtp.163.com
```bash
❌ Error: getaddrinfo ENOTFOUND smtp.163.com
💡 提示: 检查 SMTP_HOST 配置
```

**原因**：
- 网络问题
- SMTP 服务器地址错误

**解决**：
1. 检查网络连接
2. ping smtp.163.com
3. 确认 `.env` 中 `SMTP_HOST=smtp.163.com`

---

#### 错误 4：ECONNREFUSED
```bash
❌ Error: connect ECONNREFUSED 127.0.0.1:465
💡 提示: 检查端口号和防火墙设置
```

**原因**：
- 端口错误
- 防火墙阻止

**解决**：
1. 确认 `.env` 中 `SMTP_PORT=465`
2. 检查防火墙设置
3. 尝试使用端口 25（非 SSL）

---

#### 错误 5：ETIMEDOUT
```bash
❌ Error: Connection timeout
💡 提示: 检查 SMTP 服务器地址和端口
```

**原因**：连接超时

**解决**：
1. 检查网络连接
2. 尝试重启服务
3. 检查是否被运营商屏蔽端口 465

---

## 🔍 Netlify 部署环境调试

### 查看 Netlify Functions 日志

1. 登录 [Netlify](https://app.netlify.com/)
2. 选择你的站点
3. 进入 **Functions** 标签
4. 点击 **feedback** 函数
5. 查看 **Logs** 选项卡

### Netlify 日志位置

```
Functions → feedback → Logs
```

### 实时监控日志

```bash
# 使用 Netlify CLI 监控日志
npx netlify functions:invoke feedback --identity --no-cache
```

### 常见 Netlify 部署问题

#### 问题 1：环境变量未设置

**症状**：Functions 日志显示
```
❌ Missing required environment variables
```

**解决**：
1. 进入 Netlify 后台
2. Site settings → Environment variables
3. 确认所有 5 个变量都已添加：
   - SMTP_HOST
   - SMTP_PORT  
   - SMTP_USER
   - SMTP_PASS
   - FEEDBACK_RECEIVER
4. 重新部署：Deploys → Trigger deploy → Deploy site

---

#### 问题 2：函数执行超时

**症状**：
```
Function execution timed out after 10s
```

**解决**：
1. 检查 SMTP 服务器连接
2. 尝试使用更快的 SMTP 服务
3. 优化邮件发送代码

---

#### 问题 3：授权码在 Netlify 不工作

**症状**：本地测试成功，部署后失败

**原因**：环境变量中有隐藏字符或空格

**解决**：
1. 重新复制授权码（避免多余空格）
2. 在 Netlify 后台重新输入
3. 保存后重新部署

---

## 🧪 完整测试流程

### 本地测试检查清单

```bash
# 1. 检查配置
cat .env

# 2. 启动服务
pnpm docs:dev:netlify

# 3. 测试邮件发送
# 访问 http://localhost:8888
# 填写并提交反馈

# 4. 查看日志
# 在终端查看完整日志输出

# 5. 检查邮箱
# 确认收到反馈邮件
```

### 测试用例

#### 测试 1：基本功能
- 姓名：留空（测试匿名）
- 内容：测试内容
- 预期：收到邮件，姓名显示"匿名用户"

#### 测试 2：完整信息
- 姓名：张三
- 邮箱：test@example.com
- 联系方式：微信：test123
- 内容：这是一条测试反馈
- 预期：收到邮件，包含所有信息

#### 测试 3：频率限制
- 连续提交 4 次
- 预期：前 3 次成功，第 4 次提示"提交过于频繁"

#### 测试 4：表单验证
- 内容：留空
- 预期：提示"反馈内容不能为空"

#### 测试 5：邮箱格式
- 邮箱：invalid-email
- 预期：提示"邮箱格式不正确"

---

## 📝 调试命令速查表

```bash
# 查看 .env 文件
cat .env

# 检查环境变量是否加载（本地）
pnpm docs:dev:netlify
# 查看终端输出中的 "Injected .env file env vars"

# 测试 SMTP 连接
telnet smtp.163.com 465

# 测试 DNS 解析
nslookup smtp.163.com

# 查看 Node.js 版本
node --version

# 查看 netlify-cli 版本
npx netlify --version

# 查看 Netlify 站点状态
npx netlify status

# 查看 Netlify 环境变量（需要登录）
npx netlify env:list
```

---

## 💡 常见问题 FAQ

### Q1: 本地测试成功，部署后失败？

**检查清单**：
1. Netlify 环境变量是否都已配置
2. 变量值中是否有多余空格
3. 是否重新部署了站点
4. 查看 Netlify Functions 日志

### Q2: 一直提示"配置错误"？

**原因**：环境变量缺失

**解决**：
- 本地：检查 `.env` 文件
- Netlify：检查后台环境变量

### Q3: 邮件发送成功但没收到？

**检查**：
1. 垃圾邮件箱
2. 邮件过滤规则
3. 发件邮箱和收件邮箱是否相同
4. 163 邮箱是否欠费或被封

### Q4: 端口 465 连接失败？

**尝试**：
```env
# 改用端口 25（非 SSL）
SMTP_PORT=25
```

同时修改代码：
```javascript
// netlify/functions/feedback.mjs
secure: false, // 改为 false
```

### Q5: Netlify Dev 启动慢？

**正常现象**，Netlify CLI 需要：
- 检测项目类型
- 初始化 Functions
- 加载环境变量

通常需要 10-20 秒

---

## 🎯 推荐工作流程

```bash
# 1. 修改代码
# 编辑 netlify/functions/feedback.mjs 或 FeedbackWidget.vue

# 2. 本地测试
pnpm docs:dev:netlify

# 3. 确认功能正常
# 提交测试反馈，查看日志和邮箱

# 4. 提交代码
git add .
git commit -m "优化反馈功能"
git push

# 5. Netlify 自动部署
# 等待部署完成

# 6. 线上测试
# 访问正式网站测试功能
```

---

## 📚 相关资源

- [Netlify Functions 文档](https://docs.netlify.com/functions/overview/)
- [Netlify CLI 文档](https://docs.netlify.com/cli/get-started/)
- [Nodemailer 文档](https://nodemailer.com/)
- [163 邮箱帮助](https://help.mail.163.com/)

---

## 🆘 仍有问题？

如果按照上述步骤仍然无法解决，请提供以下信息：

1. **完整的错误日志**（终端输出）
2. **环境信息**：
   - Node.js 版本：`node --version`
   - 操作系统
   - 使用的邮箱服务
3. **.env 文件格式**（隐藏敏感信息）
4. **Netlify Functions 日志截图**

---

**提示**：现在日志输出非常详细，可以准确定位问题！🎉

