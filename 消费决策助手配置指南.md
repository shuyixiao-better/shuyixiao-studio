# 消费决策助手配置指南 🤖

## 📋 功能说明

消费决策助手是一个基于AI的理性消费工具，对接魔力方舟（Gitee AI）平台，帮助用户：
- 识别促销套路
- 提供替代方案
- 分析价格合理性
- 做出明智决策

## 🔐 安全机制

所有敏感信息（API Key、模型配置、提示词）通过**环境变量**存储，不会暴露在代码中，可以安全地推送到公开仓库。

## ⚙️ 环境变量配置

### 本地开发环境

在项目根目录的 `.env` 文件中添加：

```bash
# 魔力方舟（Gitee AI）配置
MOFA_API_KEY=your-api-key-here
MOFA_BASE_URL=https://ai.gitee.com/v1
MOFA_MODEL=Qwen3-235B-A22B-Instruct-2507
MOFA_TEMPERATURE=1
MOFA_MAX_TOKENS=0

# 系统提示词（可选，用于自定义AI行为）
MOFA_SYSTEM_PROMPT=你是一个理性消费教练，擅长帮用户看穿商家定价套路，做出明智的消费决策。
```

### Netlify 部署环境

1. 登录 [Netlify](https://app.netlify.com/)
2. 选择你的站点
3. 进入 **Site settings** → **Environment variables**
4. 添加以下环境变量：

| 变量名 | 说明 | 必填 | 示例值 |
|--------|------|------|--------|
| `MOFA_API_KEY` | 魔力方舟 API Key | ✅ 是 | `your-api-key` |
| `MOFA_BASE_URL` | API 基础地址 | ❌ 否 | `https://ai.gitee.com/v1` |
| `MOFA_MODEL` | 模型名称 | ❌ 否 | `Qwen3-235B-A22B-Instruct-2507` |
| `MOFA_TEMPERATURE` | 温度参数（0-2） | ❌ 否 | `1` |
| `MOFA_MAX_TOKENS` | 最大token数 | ❌ 否 | `0`（无限制） |
| `MOFA_SYSTEM_PROMPT` | 系统提示词 | ❌ 否 | 自定义提示词 |

5. 保存后，**重新部署站点**

### GitHub Actions 部署环境

如果你使用 GitHub Actions 部署：

1. 进入 GitHub 仓库
2. 点击 **Settings** → **Secrets and variables** → **Actions**
3. 添加相同的 Secrets（变量名相同）

## 📝 配置说明

### MOFA_API_KEY（必填）

魔力方舟（Gitee AI）的 API Key，需要：
1. 登录 [Gitee AI 平台](https://ai.gitee.com)
2. 创建应用或获取 API Key
3. 复制 Key 到环境变量

### MOFA_BASE_URL（可选）

API 基础地址，默认值：`https://ai.gitee.com/v1`

如果使用其他兼容 OpenAI 协议的平台，可以修改此值。

### MOFA_MODEL（可选）

使用的模型名称，默认值：`Qwen3-235B-A22B-Instruct-2507`

可根据需要切换到其他模型：
- `Qwen3-235B-A22B-Instruct-2507`（推荐）
- 其他可用模型请查看 Gitee AI 文档

### MOFA_TEMPERATURE（可选）

控制输出的随机性：
- `0`：确定性输出，更保守
- `1`：平衡（默认）
- `2`：更创造性

默认值：`1`

### MOFA_MAX_TOKENS（可选）

限制生成的最大token数：
- `0`：无限制（默认）
- `1000`：限制1000个token
- 其他数值

默认值：`0`

### MOFA_SYSTEM_PROMPT（可选）

系统提示词，用于定义AI的角色和行为。如果不配置，将使用组件内置的默认提示词。

示例：
```
你是一个理性消费教练，擅长帮用户看穿商家定价套路，做出明智的消费决策。
```

## 🧪 本地测试

1. 配置好 `.env` 文件
2. 启动开发服务器：
   ```bash
   pnpm docs:dev:netlify
   ```
3. 访问：`http://localhost:8888/tools/consumer-copilot/`
4. 输入测试问题，检查AI响应

## 🚀 功能特性

- ✅ **环境检测**：仅在 Netlify 环境可用（GitHub Pages 自动隐藏）
- ✅ **知识库增强**：内置消费知识库（RAG）
- ✅ **对话历史**：支持多轮对话
- ✅ **Markdown渲染**：AI回复支持Markdown格式
- ✅ **响应式设计**：手机端完美适配
- ✅ **流式输出**：支持实时显示（可扩展）

## 📊 知识库

知识库文件位置：`docs/.vitepress/data/consumer-knowledge.json`

包含以下类别：
- 电商折扣规则
- 消费心理学
- 促销陷阱识别
- 价格策略分析
- 理性消费方法论

可以随时编辑此文件添加新的知识条目。

## 🔧 自定义提示词

如果需要自定义AI的行为，可以：

1. **方式1**：设置 `MOFA_SYSTEM_PROMPT` 环境变量
2. **方式2**：编辑 `ConsumerCopilot.vue` 中的 `buildSystemPrompt()` 函数

## 📱 小程序/手机端支持

组件已完全响应式设计，支持：
- ✅ 手机浏览器访问
- ✅ 微信小程序内嵌（WebView）
- ✅ 平板设备

关键特性：
- 触摸友好的按钮大小
- 自适应布局
- 优化的输入体验

## ⚠️ 常见问题

### Q1: 提示"AI服务配置错误"

**原因**：`MOFA_API_KEY` 未配置或配置错误

**解决**：
1. 检查 Netlify 环境变量是否已配置
2. 确认 API Key 正确无误
3. 重新部署站点

### Q2: 返回"API Key认证失败"

**原因**：API Key 无效或已过期

**解决**：
1. 重新生成 API Key
2. 更新环境变量
3. 重新部署

### Q3: 提示"请求过于频繁"

**原因**：触发了频率限制（每IP每分钟最多10次）

**解决**：等待1分钟后重试

### Q4: GitHub Pages 部署后功能不可用

**原因**：GitHub Pages 是静态网站，不支持 Netlify Functions

**解决**：这是正常现象，功能会在 GitHub Pages 自动隐藏，仅在 Netlify 部署时可用

### Q5: 如何修改知识库

编辑 `docs/.vitepress/data/consumer-knowledge.json` 文件，添加新的知识条目：

```json
{
  "knowledge_base": {
    "new_rule": {
      "category": "新分类",
      "rule": "你的规则内容",
      "source": "来源说明",
      "tags": ["标签1", "标签2"]
    }
  }
}
```

## 📈 使用统计

- API 端点：`/api/chat`
- 请求方法：POST
- 频率限制：10次/分钟/IP
- 支持对话历史
- 支持流式输出（待扩展）

## 🆘 技术支持

如遇问题，请检查：

1. **浏览器控制台**：查看前端错误信息
2. **Netlify Functions 日志**：
   - 进入 Netlify 后台
   - Functions → chat → Logs
3. **环境变量**：确认所有变量已正确配置

## 📚 相关文件

- **后端函数**: `netlify/functions/chat.mjs`
- **前端组件**: `docs/.vitepress/theme/components/ConsumerCopilot.vue`
- **知识库**: `docs/.vitepress/data/consumer-knowledge.json`
- **页面**: `docs/tools/consumer-copilot/index.md`
- **主题集成**: `docs/.vitepress/theme/index.js`

---

**注意**：环境变量配置完成后，记得**重新部署**站点才能生效！

