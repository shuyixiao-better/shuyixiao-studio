# ESåŠ¨æ€æ˜ å°„ï¼ˆDynamic Field Mappingï¼‰æ•…äº‹ç‰ˆ

> ## 3.1 è‡ªåŠ¨æ˜ å°„ï¼šDynamic field mapping
>
> | **field type** | **dynamic**                        |
> | :------------: | ---------------------------------- |
> |   true/false   | boolean                            |
> |      å°æ•°      | float                              |
> |      æ•°å­—      | long                               |
> |     object     | object                             |
> |      æ•°ç»„      | å–å†³äºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªéç©ºå…ƒç´ çš„ç±»å‹ |
> | æ—¥æœŸæ ¼å¼å­—ç¬¦ä¸² | date                               |
> | æ•°å­—ç±»å‹å­—ç¬¦ä¸² | float/long                         |
> |   å…¶ä»–å­—ç¬¦ä¸²   | text + keyword                     |
>
> é™¤äº†ä¸Šè¿°å­—æ®µç±»å‹ä¹‹å¤–ï¼Œå…¶ä»–ç±»å‹éƒ½å¿…é¡»æ˜¾ç¤ºæ˜ å°„ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»æ‰‹å·¥æŒ‡å®šï¼Œå› ä¸ºå…¶ä»–ç±»å‹ESæ— æ³•è‡ªåŠ¨è¯†åˆ«ã€‚
å¥½çš„ï¼Œè®©æˆ‘ä»¬ç”¨æ•°å­—æ‘çš„æ•…äº‹æ¥è®²è§£è¿™ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µâ€”â€”**åŠ¨æ€æ˜ å°„ï¼ˆDynamic Field Mappingï¼‰**ï¼

---

## **æ•…äº‹ï¼šæ•°å­—æ‘çš„æ™ºèƒ½ä»“åº“ç®¡ç†å‘˜**

æƒ³è±¡æ•°å­—æ‘æœ‰ä¸€ä¸ªè¶…çº§æ™ºèƒ½çš„ä»“åº“ç®¡ç†å‘˜ï¼Œåå«**åŠ¨å”**ã€‚ä»–çš„å·¥ä½œæ˜¯ï¼šæ¯å½“æœ‰æ‘æ°‘é€æ¥æ–°çš„è´§ç‰©ï¼ˆæ–‡æ¡£ï¼‰æ—¶ï¼Œä»–éœ€è¦**è‡ªåŠ¨åˆ¤æ–­**è¿™ä¸ªè´§ç‰©åº”è¯¥æ”¾åœ¨å“ªä¸ª**ä¸“å±è´§æ¶ï¼ˆå­—æ®µç±»å‹ï¼‰**ä¸Šã€‚

åŠ¨å”éå¸¸èªæ˜ï¼Œä»–æœ‰ä¸€å¥—è‡ªå·±çš„"è¯†è´§å®å…¸"ï¼ˆåŠ¨æ€æ˜ å°„è§„åˆ™ï¼‰ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå®å…¸æœ‰æ—¶å€™ä¹Ÿä¼šåˆ¤æ–­å¤±è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦äº†è§£ä»–çš„åˆ¤æ–­é€»è¾‘ï¼

### **åŠ¨å”çš„"è¯†è´§å®å…¸"ï¼ˆåŠ¨æ€æ˜ å°„è§„åˆ™ï¼‰**

| **æ‘æ°‘é€æ¥çš„è´§ç‰©** | **åŠ¨å”çš„åˆ¤æ–­** | **æ”¾ç½®çš„è´§æ¶** | **æ•…äº‹æ¯”å–»** |
|-------------------|----------------|----------------|-------------|
| `true` / `false` | "è¿™æ˜æ˜¾æ˜¯ä¸ªå¼€å…³å˜›ï¼" | **boolean**ï¼ˆå¸ƒå°”å‹ï¼‰ | **æ˜¯éå¼€å…³é“º** - åªæœ‰å¼€/å…³ä¸¤ç§çŠ¶æ€ |
| `3.14` / `2.71` | "å¸¦å°æ•°ç‚¹çš„æ•°å­—ï¼" | **float**ï¼ˆæµ®ç‚¹å‹ï¼‰ | **å®ç”¨é‡å…·åº—** - å¤„ç†å¸¦ç²¾åº¦çš„æµ‹é‡å€¼ |
| `42` / `1000` | "è¿™æ˜¯ä¸ªæ•´æ•°ï¼" | **long**ï¼ˆé•¿æ•´å‹ï¼‰ | **æ•´æ•°æ‚è´§é“º** - å­˜æ”¾æ™®é€šæ•´æ•° |
| `{"name": "å¼ ä¸‰"}` | "è¿™æ˜¯ä¸ªåŒ…è£¹å¯¹è±¡ï¼" | **object**ï¼ˆå¯¹è±¡å‹ï¼‰ | **ä¸‡èƒ½æ‚ç‰©é—´** - å­˜æ”¾ç»„åˆç‰©å“ |
| `[1, 2, 3]` | "çœ‹çœ‹æ•°ç»„é‡Œç¬¬ä¸€ä¸ªæ˜¯ä»€ä¹ˆ..." | **å–å†³äºç¬¬ä¸€ä¸ªå…ƒç´ çš„ç±»å‹** | **çœ‹ç¬¬ä¸€ä¸ªç‰©å“å†³å®šæ”¾å“ªä¸ªè´§æ¶** |
| `"2023-10-01"` | "è¿™çœ‹èµ·æ¥åƒæ—¥æœŸï¼" | **date**ï¼ˆæ—¥æœŸå‹ï¼‰ | **æ ‡å‡†æ—¶é—´ç™»è®°å¤„** - è¯†åˆ«æ—¥æœŸæ ¼å¼ |
| `"123"` / `"3.14"` | "æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²ï¼" | **float**/**long**ï¼ˆæ•°å­—å‹ï¼‰ | **å½“æˆæ•°å­—å¤„ç†ï¼Œå»æ‰å¼•å·** |
| `"hello world"` | "æ™®é€šæ–‡æœ¬å†…å®¹ï¼" | **text + keyword**ï¼ˆæ–‡æœ¬+å…³é”®å­—ï¼‰ | **å…¨æ–‡æ£€ç´¢å¤§å¸ˆ + ç²¾ç¡®èº«ä»½è¯ç™»è®°å¤„** |

---

### **è¯¦ç»†å‰§æƒ…å±•å¼€**

#### **1. å¸ƒå°”å€¼çš„è‡ªåŠ¨è¯†åˆ«**
```json
// æ‘æ°‘é€æ¥ï¼š
{"is_student": true, "has_car": false}

// åŠ¨å”åˆ¤æ–­ï¼š
"is_student" â†’ booleanç±»å‹ï¼ˆæ˜¯éå¼€å…³é“ºï¼‰
"has_car" â†’ booleanç±»å‹ï¼ˆæ˜¯éå¼€å…³é“ºï¼‰
```

#### **2. æ•°å­—çš„è‡ªåŠ¨è¯†åˆ«**
```json
// æ‘æ°‘é€æ¥ï¼š
{"price": 19.99, "quantity": 100}

// åŠ¨å”åˆ¤æ–­ï¼š
"price" â†’ floatç±»å‹ï¼ˆå®ç”¨é‡å…·åº—ï¼‰- å› ä¸ºæœ‰å°æ•°ç‚¹
"quantity" â†’ longç±»å‹ï¼ˆæ•´æ•°æ‚è´§é“ºï¼‰- å› ä¸ºæ˜¯æ•´æ•°
```

#### **3. å¯¹è±¡çš„è‡ªåŠ¨è¯†åˆ«**
```json
// æ‘æ°‘é€æ¥ï¼š
{"user": {"name": "å¼ ä¸‰", "age": 25}}

// åŠ¨å”åˆ¤æ–­ï¼š
"user" â†’ objectç±»å‹ï¼ˆä¸‡èƒ½æ‚ç‰©é—´ï¼‰
"user.name" â†’ text + keywordï¼ˆå…¨æ–‡+ç²¾ç¡®ï¼‰
"user.age" â†’ longç±»å‹ï¼ˆæ•´æ•°æ‚è´§é“ºï¼‰
```

#### **4. æ•°ç»„çš„"çœ‹ç¬¬ä¸€ä¸ª"è§„åˆ™**
```json
// åœºæ™¯1ï¼šæ•°å­—æ•°ç»„
{"scores": [95, 87, 92]}
// åŠ¨å”çœ‹ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š95 â†’ longç±»å‹

// åœºæ™¯2ï¼šå­—ç¬¦ä¸²æ•°ç»„  
{"tags": ["ä¿ƒé”€", "æ–°å“", "çƒ­å–"]}
// åŠ¨å”çœ‹ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š"ä¿ƒé”€" â†’ text + keywordç±»å‹

// åœºæ™¯3ï¼šç©ºæ•°ç»„
{"empty_list": []}
// åŠ¨å”æ‡µé€¼äº†ï¼šæ— æ³•åˆ¤æ–­ç±»å‹ï¼å¯èƒ½æŠ¥é”™æˆ–å¿½ç•¥
```

#### **5. æ—¥æœŸçš„æ™ºèƒ½è¯†åˆ«**
```json
// æ‘æ°‘é€æ¥ï¼š
{"birthday": "1990-05-15", "create_time": "2023/10/01 14:30:00"}

// åŠ¨å”åˆ¤æ–­ï¼š
è¿™ä¸¤ä¸ªéƒ½ç¬¦åˆå¸¸è§çš„æ—¥æœŸæ ¼å¼ â†’ dateç±»å‹ï¼ˆæ ‡å‡†æ—¶é—´ç™»è®°å¤„ï¼‰
```

#### **6. æ•°å­—å­—ç¬¦ä¸²çš„ç‰¹æ®Šå¤„ç†**
```json
// æ‘æ°‘é€æ¥ï¼š
{"age_str": "25", "price_str": "19.99"}

// åŠ¨å”åˆ¤æ–­ï¼š
"age_str" â†’ longç±»å‹ï¼ˆå»æ‰å¼•å·å½“æˆæ•°å­—25ï¼‰
"price_str" â†’ floatç±»å‹ï¼ˆå»æ‰å¼•å·å½“æˆæ•°å­—19.99ï¼‰
```

#### **7. æ–‡æœ¬çš„"åŒé‡ä¿éšœ"**
```json
// æ‘æ°‘é€æ¥ï¼š
{"title": "Elasticsearchæ•™ç¨‹", "content": "è¿™æ˜¯ä¸€ä¸ªè¯¦ç»†çš„æ•™å­¦æ–‡æ¡£..."}

// åŠ¨å”åˆ¤æ–­ï¼š
ä¸ºè¿™ä¸¤ä¸ªå­—æ®µåŒæ—¶åˆ›å»ºä¸¤ç§æ˜ å°„ï¼š
- textç±»å‹ï¼šç”¨äºå…¨æ–‡æœç´¢ï¼ˆå¯ä»¥è¢«åˆ†è¯ï¼š"Elasticsearchæ•™ç¨‹" â†’ "Elasticsearch" + "æ•™ç¨‹"ï¼‰
- keywordç±»å‹ï¼šç”¨äºç²¾ç¡®åŒ¹é…ï¼ˆå¿…é¡»å®Œå…¨åŒ¹é…"Elasticsearchæ•™ç¨‹"ï¼‰
```

---

### **åŠ¨å”çš„å±€é™æ€§ï¼šå¿…é¡»æ˜¾å¼æŒ‡å®šçš„ç‰¹æ®Šè´§æ¶**

æœ‰äº›ç‰¹æ®Šçš„è´§ç‰©ï¼ŒåŠ¨å”çš„å®å…¸é‡Œæ²¡æœ‰è®°å½•ï¼Œ**å¿…é¡»ç”±æ‘æ°‘æ˜ç¡®è¯´æ˜**åº”è¯¥æ”¾åœ¨å“ªä¸ªè´§æ¶ï¼š

```json
// è¿™äº›ç±»å‹åŠ¨å”æ— æ³•è‡ªåŠ¨è¯†åˆ«ï¼Œå¿…é¡»æ˜¾å¼æ˜ å°„ï¼š

// 1. åœ°ç†ä½ç½®
{"location": "40.7128,-74.0060"}  // åŠ¨å”ä¼šè¯¯åˆ¤ä¸ºtextï¼Œä½†å…¶å®æ˜¯geo_pointï¼

// 2. IPåœ°å€
{"ip": "192.168.1.1"}  // åŠ¨å”ä¼šè¯¯åˆ¤ä¸ºtextï¼Œä½†åº”è¯¥æ˜¯ipç±»å‹ï¼

// 3. åŠç²¾åº¦æµ®ç‚¹æ•°
{"temperature": 25.5}  // åŠ¨å”ä¼šåˆ¤æ–­ä¸ºfloatï¼Œä½†å¯èƒ½æ˜¯half_floatï¼

// 4. åµŒå¥—ç±»å‹
{"comments": [{"user": "å¼ ä¸‰", "content": "å¥½æ–‡ï¼"}]}  // åŠ¨å”ä¼šåˆ¤æ–­ä¸ºobjectï¼Œä½†å¯èƒ½æ˜¯nestedï¼

// 5. å®Œæˆå»ºè®®
{"suggest": "Elasticsearch"}  // åŠ¨å”ä¼šåˆ¤æ–­ä¸ºtextï¼Œä½†å¯èƒ½æ˜¯completionï¼
```

---

### **å®æˆ˜å»ºè®®ï¼šä»€ä¹ˆæ—¶å€™ç›¸ä¿¡åŠ¨å”ï¼Ÿä»€ä¹ˆæ—¶å€™äº²è‡ªæŒ‡å®šï¼Ÿ**

#### **âœ… å¯ä»¥ç›¸ä¿¡åŠ¨å”çš„åœºæ™¯ï¼ˆä½¿ç”¨åŠ¨æ€æ˜ å°„ï¼‰ï¼š**
- **å¼€å‘æµ‹è¯•é˜¶æ®µ**ï¼šå¿«é€ŸéªŒè¯æƒ³æ³•
- **æ•°æ®ç»“æ„ç®€å•**ä¸”ç¬¦åˆå¸¸è§„æ¨¡å¼
- **æ—¥å¿—ç±»æ•°æ®**ï¼šå­—æ®µå¤šå˜ï¼Œä¸éœ€è¦ä¸¥æ ¼çº¦æŸ

#### **âŒ å¿…é¡»äº²è‡ªæŒ‡å®šçš„åœºæ™¯ï¼ˆä½¿ç”¨æ˜¾å¼æ˜ å°„ï¼‰ï¼š**
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šéœ€è¦ç¨³å®šå¯é çš„æ˜ å°„
- **ç‰¹æ®Šæ•°æ®ç±»å‹**ï¼šgeo_pointã€ipã€nestedç­‰
- **æ€§èƒ½ä¼˜åŒ–**ï¼šéœ€è¦ç²¾ç»†æ§åˆ¶åˆ†è¯å™¨ã€ç´¢å¼•é€‰é¡¹ç­‰
- **ä¸šåŠ¡å…³é”®å­—æ®µ**ï¼šå¦‚å•†å“IDã€ç”¨æˆ·IDç­‰

#### **æ˜¾å¼æ˜ å°„ç¤ºä¾‹ï¼š**
```json
// åœ¨åˆ›å»ºç´¢å¼•æ—¶æ˜ç¡®æŒ‡å®šæ˜ å°„
PUT /my_index
{
  "mappings": {
    "properties": {
      "location": {
        "type": "geo_point"  // æ˜ç¡®å‘Šè¯‰åŠ¨å”ï¼šè¿™æ˜¯åœ°ç†åæ ‡ï¼
      },
      "ip_address": {
        "type": "ip"  // æ˜ç¡®å‘Šè¯‰åŠ¨å”ï¼šè¿™æ˜¯IPåœ°å€ï¼
      },
      "product_id": {
        "type": "keyword"  // æ˜ç¡®å‘Šè¯‰åŠ¨å”ï¼šè¿™ä¸ªåªè¦ç²¾ç¡®åŒ¹é…ï¼
      }
    }
  }
}
```

---

## **æ•…äº‹æ€»ç»“**

æ•°å­—æ‘çš„æ™ºèƒ½ç®¡ç†å‘˜**åŠ¨å”**è™½ç„¶å¾ˆèªæ˜ï¼Œä½†ä»–çš„"è‡ªåŠ¨åˆ¤æ–­"æœ‰æ—¶ä¼šå‡ºé”™ã€‚äº†è§£ä»–çš„åˆ¤æ–­è§„åˆ™ï¼ˆåŠ¨æ€æ˜ å°„è§„åˆ™ï¼‰éå¸¸é‡è¦ï¼š

1. **è®°ä½å®å…¸**ï¼šäº†è§£å„ç§æ•°æ®ç±»å‹ä¼šè¢«è‡ªåŠ¨æ˜ å°„æˆä»€ä¹ˆ
2. **çŸ¥é“å±€é™**ï¼šæ˜ç™½å“ªäº›ç±»å‹å¿…é¡»æ˜¾å¼æŒ‡å®š
3. **é€‚æ—¶å¹²é¢„**ï¼šåœ¨é‡è¦åœºåˆäº²è‡ªæŒ‡å®šæ˜ å°„ï¼Œé¿å…æ„å¤–

è¿™æ ·ï¼Œä½ å°±èƒ½åœ¨äº«å—åŠ¨æ€æ˜ å°„ä¾¿åˆ©çš„åŒæ—¶ï¼Œé¿å…æ‰è¿›æ˜ å°„é”™è¯¯çš„å‘é‡Œï¼ğŸ¯

> #Dynamic mapping
> DELETE product_mapping
> GET product_mapping/_mapping
> PUT /product_mapping/_doc/1
> {
>   "name": "xiaomi phone",
>   "desc": "shouji zhong de zhandouji",
>   "count": 123456,
>   "price": 123.123,
>   "date": "2020-05-20",
>   "isdel": false,
>   "tags": [
>     "xingjiabi",
>     "fashao",
>     "buka"
>   ]
> }
>
> GET product_mapping/_search
> {
>   "query": {
>     "match": {
>       "name.keyword": "xiaomi phone"
>     }
>   }
> }

è®©æˆ‘ä»¬è¯¦ç»†åˆ†æè¿™æ®µ Elasticsearch æ“ä½œï¼Œç†è§£åŠ¨æ€æ˜ å°„çš„å®é™…åº”ç”¨ï¼š

### æ“ä½œæµç¨‹è§£æ

1. **åˆ é™¤ç´¢å¼•ï¼ˆæ¸…ç†ç¯å¢ƒï¼‰**
   ```bash
   DELETE product_mapping
   ```
   - åˆ é™¤åä¸º `product_mapping` çš„ç´¢å¼•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
   - ç›¸å½“äºæ•°å­—æ‘çš„"æ‹†è¿é˜Ÿ"ï¼Œæ¸…ç©ºåœºåœ°å‡†å¤‡é‡å»º

2. **æŸ¥çœ‹æ˜ å°„ï¼ˆæ­¤æ—¶ç´¢å¼•ä¸å­˜åœ¨ï¼‰**
   ```bash
   GET product_mapping/_mapping
   ```
   - å°è¯•æŸ¥çœ‹æ˜ å°„ï¼Œä½†ç´¢å¼•å·²è¢«åˆ é™¤ï¼Œä¼šè¿”å›é”™è¯¯
   - ç›¸å½“äºæŸ¥çœ‹"ä»“åº“è®¾è®¡å›¾"ï¼Œä½†ä»“åº“å·²è¢«æ‹†é™¤

3. **åˆ›å»ºæ–‡æ¡£ï¼ˆè§¦å‘åŠ¨æ€æ˜ å°„ï¼‰**
   ```bash
   PUT /product_mapping/_doc/1
   {
     "name": "xiaomi phone",
     "desc": "shouji zhong de zhandouji",
     "count": 123456,
     "price": 123.123,
     "date": "2020-05-20",
     "isdel": false,
     "tags": ["xingjiabi", "fashao", "buka"]
   }
   ```
   - **åŠ¨å”ï¼ˆåŠ¨æ€æ˜ å°„ï¼‰å¼€å§‹å·¥ä½œ**ï¼š
     - `name`: å­—ç¬¦ä¸² â†’ `text` + `keyword` ç±»å‹
     - `desc`: å­—ç¬¦ä¸² â†’ `text` + `keyword` ç±»å‹
     - `count`: æ•´æ•° â†’ `long` ç±»å‹
     - `price`: å°æ•° â†’ `float` ç±»å‹
     - `date`: æ—¥æœŸæ ¼å¼å­—ç¬¦ä¸² â†’ `date` ç±»å‹
     - `isdel`: å¸ƒå°”å€¼ â†’ `boolean` ç±»å‹
     - `tags`: å­—ç¬¦ä¸²æ•°ç»„ â†’ `text` + `keyword` ç±»å‹

4. **æ‰§è¡ŒæŸ¥è¯¢ï¼ˆéªŒè¯åŠ¨æ€æ˜ å°„ç»“æœï¼‰**
   ```bash
   GET product_mapping/_search
   {
     "query": {
       "match": {
         "name.keyword": "xiaomi phone"
       }
     }
   }
   ```
   - ä½¿ç”¨ `name.keyword` è¿›è¡Œç²¾ç¡®åŒ¹é…æŸ¥è¯¢
   - éªŒè¯åŠ¨æ€æ˜ å°„æ˜¯å¦åˆ›å»ºäº† `keyword` å­å­—æ®µ

### åŠ¨æ€æ˜ å°„çš„å®é™…æ•ˆæœ

æ‰§è¡Œä¸Šè¿°æ“ä½œåï¼ŒElasticsearch ä¼šè‡ªåŠ¨åˆ›å»ºå¦‚ä¸‹æ˜ å°„ï¼š

```json
{
  "product_mapping": {
    "mappings": {
      "properties": {
        "count": {"type": "long"},
        "date": {"type": "date"},
        "desc": {
          "type": "text",
          "fields": {"keyword": {"type": "keyword", "ignore_above": 256}}
        },
        "isdel": {"type": "boolean"},
        "name": {
          "type": "text",
          "fields": {"keyword": {"type": "keyword", "ignore_above": 256}}
        },
        "price": {"type": "float"},
        "tags": {
          "type": "text",
          "fields": {"keyword": {"type": "keyword", "ignore_above": 256}}
        }
      }
    }
  }
}
```

### å…³é”®çŸ¥è¯†ç‚¹è§£æ

1. **ä¸ºä»€ä¹ˆä½¿ç”¨ `name.keyword`ï¼Ÿ**
   - åŠ¨æ€æ˜ å°„ä¸ºå­—ç¬¦ä¸²å­—æ®µåŒæ—¶åˆ›å»ºäº†ï¼š
     - `text` ç±»å‹ï¼šç”¨äºå…¨æ–‡æœç´¢ï¼ˆä¼šè¢«åˆ†è¯ï¼‰
     - `keyword` ç±»å‹ï¼šç”¨äºç²¾ç¡®åŒ¹é…ï¼ˆä¸ä¼šè¢«åˆ†è¯ï¼‰
   - æŸ¥è¯¢ `"xiaomi phone"` éœ€è¦å®Œå…¨åŒ¹é…ï¼Œæ‰€ä»¥ä½¿ç”¨ `keyword` ç±»å‹

2. **`ignore_above: 256` çš„å«ä¹‰**
   - å½“å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡ 256 å­—ç¬¦æ—¶ï¼Œ`keyword` å­—æ®µå°†ä¸è¢«ç´¢å¼•
   - é˜²æ­¢é•¿æ–‡æœ¬å ç”¨è¿‡å¤šå­˜å‚¨ç©ºé—´
   - å¯ä»¥é€šè¿‡æ˜¾å¼æ˜ å°„ä¿®æ”¹è¿™ä¸ªå€¼

3. **æ—¥æœŸå­—æ®µçš„æ™ºèƒ½è¯†åˆ«**
   - `"2020-05-20"` è¢«æ­£ç¡®è¯†åˆ«ä¸ºæ—¥æœŸç±»å‹
   - Elasticsearch æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼çš„è‡ªåŠ¨è¯†åˆ«

### åŠ¨æ€æ˜ å°„çš„æ½œåœ¨é—®é¢˜

1. **æ•°å­—å­—ç¬¦ä¸²çš„è¯¯åˆ¤**
   ```json
   PUT /product_mapping/_doc/2
   {
     "product_id": "10001"  // ä¼šè¢«è¯†åˆ«ä¸º long ç±»å‹ï¼
   }
   ```
   - è§£å†³æ–¹æ¡ˆï¼šæå‰æ˜¾å¼å£°æ˜ä¸º `keyword` ç±»å‹

2. **ç‰¹æ®Šç±»å‹æ— æ³•è‡ªåŠ¨è¯†åˆ«**
   - å¦‚æœéœ€è¦ `geo_point`ã€`ip` ç­‰ç‰¹æ®Šç±»å‹ï¼Œå¿…é¡»æ˜¾å¼å£°æ˜

3. **å­—æ®µç±»å‹ä¸ä¸€è‡´**
   - å¦‚æœåç»­æ–‡æ¡£ä¸­åŒä¸€å­—æ®µå‡ºç°ä¸åŒç±»å‹æ•°æ®ï¼š
     ```json
     // ç¬¬ä¸€ä¸ªæ–‡æ¡£
     {"price": 199.9}      // â†’ float
     
     // ç¬¬äºŒä¸ªæ–‡æ¡£
     {"price": "199.9"}    // â†’ text + keyword
     ```
   - ä¼šå¯¼è‡´æ˜ å°„å†²çªå’Œç´¢å¼•å¤±è´¥

### æœ€ä½³å®è·µå»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ˜¾å¼æ˜ å°„**
   ```json
   PUT /product_mapping
   {
     "mappings": {
       "properties": {
         "product_id": {"type": "keyword"},
         "name": {
           "type": "text",
           "fields": {"raw": {"type": "keyword"}}
         },
         "price": {"type": "scaled_float", "scaling_factor": 100}
       }
     }
   }
   ```

2. **æ§åˆ¶åŠ¨æ€æ˜ å°„è¡Œä¸º**
   ```json
   PUT /product_mapping
   {
     "mappings": {
       "dynamic": "strict",  // ç¦æ­¢æœªå®šä¹‰çš„å­—æ®µ
       "properties": {...}
     }
   }
   ```

3. **é‡è¦å­—æ®µæ˜¾å¼å£°æ˜**
   - æ ‡è¯†å­—æ®µï¼ˆIDã€ç¼–ç ç­‰ï¼‰è®¾ä¸º `keyword`
   - æ•°å€¼å­—æ®µæ˜ç¡®æŒ‡å®š `float`/`double`/`integer`
   - æ—¥æœŸå­—æ®µæŒ‡å®šæ ¼å¼ `"format": "yyyy-MM-dd"`

é€šè¿‡ç†è§£åŠ¨æ€æ˜ å°„æœºåˆ¶ï¼Œä½ å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨ Elasticsearch çš„çµæ´»æ€§ï¼ŒåŒæ—¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é æ€§ï¼



> ## 3.2 æ˜¾ç¤ºæ˜ å°„ Expllcit field mapping
>
> ```json
> PUT /product
> {
>   "mappings": {
>     "properties": {
>       "field": {
>         "mapping_parameter": "parameter_value",
> 		...
>       },
> 	  ...
>     }
>   }
> }
> ```
>
> è¯¾ç¨‹æ¼”ç¤ºDSLï¼š
>
> ```java
> #æ‰‹å·¥åˆ›å»ºmappingï¼ˆfieldsçš„mappingåªèƒ½åˆ›å»ºï¼Œæ— æ³•ä¿®æ”¹ï¼‰
> #è¯­æ³•
> delete /product
> GET product/_mapping
> PUT /product
> {
>    "mappings" : {
>       "properties" : {
>         "count" : {
>           "type" : "long"
>         },
>         "date" : {
>           "type" : "date"
>         },
>         "desc" : {
>           "type" : "text",
>           "fields" : {
>             "keyword" : {
>               "type" : "keyword",
>               "ignore_above" : 256
>             }
>           }
>         },
>         "isdel" : {
>           "type" : "boolean"
>         },
>         "name" : {
>           "type" : "text",
>           "fields" : {
>             "keyword" : {
>               "type" : "keyword",
>               "ignore_above" : 256
>             }
>           }
>         },
>         "price" : {
>           "type" : "float"
>         },
>         "tags" : {
>           "type" : "text",
>           "fields" : {
>             "keyword" : {
>               "type" : "keyword",
>               "ignore_above" : 256
>             }
>           }
>         }
>       }
>     }
> }
> 
> 
> PUT /product/_doc/1{
>   "name": "xiaomi phone",
>   "desc": "shouji zhong de zhandouji",
>   "count": 123456,
>   "price": 123.123,
>   "date": "2020-05-20",
>   "isdel": false
> }
> ```
># Elasticsearch æ˜¾å¼æ˜ å°„è¯¦è§£

è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨æ˜¾å¼æ˜ å°„ï¼ˆExplicit Field Mappingï¼‰çš„æ¦‚å¿µï¼Œå¹¶é€šè¿‡å®é™…ç¤ºä¾‹æ¼”ç¤ºå…¶åº”ç”¨ã€‚

## æ˜¾å¼æ˜ å°„çš„æ ¸å¿ƒæ¦‚å¿µ

æ˜¾å¼æ˜ å°„æ˜¯ Elasticsearch ä¸­**æ‰‹åŠ¨å®šä¹‰å­—æ®µç±»å‹å’Œå±æ€§**çš„æ–¹å¼ï¼Œä¸åŠ¨æ€æ˜ å°„ç›¸å¯¹ã€‚å®ƒæä¾›äº†å¯¹æ•°æ®ç»“æ„çš„ç²¾ç¡®æ§åˆ¶ï¼Œæ˜¯ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µã€‚

### åŸºæœ¬è¯­æ³•ç»“æ„
```json
PUT /index_name
{
  "mappings": {
    "properties": {
      "field_name": {
        "type": "field_type",
        "parameter1": "value1",
        "parameter2": "value2"
      },
      // æ›´å¤šå­—æ®µå®šä¹‰...
    }
  }
}
```

## è¯¾ç¨‹ç¤ºä¾‹è§£æ

### 1. åˆ›å»ºç´¢å¼•å¹¶å®šä¹‰æ˜¾å¼æ˜ å°„
```json
PUT /product
{
  "mappings": {
    "properties": {
      "count": {"type": "long"},
      "date": {"type": "date"},
      "desc": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "isdel": {"type": "boolean"},
      "name": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "price": {"type": "float"},
      "tags": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      }
    }
  }
}
```

### 2. æ’å…¥æ–‡æ¡£
```json
PUT /product/_doc/1
{
  "name": "xiaomi phone",
  "desc": "shouji zhong de zhandouji",
  "count": 123456,
  "price": 123.123,
  "date": "2020-05-20",
  "isdel": false
}
```

## æ˜¾å¼æ˜ å°„çš„æ ¸å¿ƒä¼˜åŠ¿

1. **ç²¾ç¡®æ§åˆ¶å­—æ®µç±»å‹**
   - é¿å…åŠ¨æ€æ˜ å°„çš„è¯¯åˆ¤
   - ç¡®ä¿ç‰¹æ®Šç±»å‹æ­£ç¡®è¯†åˆ«ï¼ˆå¦‚geo_point, ipç­‰ï¼‰

2. **ä¼˜åŒ–å­˜å‚¨å’Œæ€§èƒ½**
   - è®¾ç½®åˆé€‚çš„ç´¢å¼•é€‰é¡¹
   - é…ç½®å­—æ®µå‹ç¼©æ–¹å¼
   - æ§åˆ¶åˆ†è¯å™¨è¡Œä¸º

3. **å¤šå­—æ®µæ”¯æŒ**
   ```json
   "name": {
     "type": "text",          // ç”¨äºå…¨æ–‡æœç´¢
     "fields": {
       "raw": {"type": "keyword"},  // ç”¨äºç²¾ç¡®åŒ¹é…
       "english": {           // ç”¨äºç‰¹å®šè¯­è¨€åˆ†æ
         "type": "text",
         "analyzer": "english"
       }
     }
   }
   ```

4. **é˜²æ­¢æ˜ å°„çˆ†ç‚¸**
   - é€šè¿‡æ˜¾å¼æ˜ å°„é™åˆ¶å­—æ®µæ•°é‡
   - é¿å…åŠ¨æ€åˆ›å»ºè¿‡å¤šå­—æ®µ

## å¸¸ç”¨æ˜ å°„å‚æ•°è¯¦è§£

### 1. æ ¸å¿ƒå‚æ•°
- `type`: å­—æ®µç±»å‹ï¼ˆtext, keyword, long, dateç­‰ï¼‰
- `index`: æ˜¯å¦ç´¢å¼•ï¼ˆ`true`/`false`ï¼‰
- `doc_values`: æ˜¯å¦å¯ç”¨åˆ—å¼å­˜å‚¨ï¼ˆç”¨äºæ’åºå’Œèšåˆï¼‰

### 2. æ–‡æœ¬å­—æ®µå‚æ•°
- `analyzer`: æŒ‡å®šåˆ†è¯å™¨ï¼ˆå¦‚standard, ik_smartç­‰ï¼‰
- `search_analyzer`: æŒ‡å®šæœç´¢æ—¶ä½¿ç”¨çš„åˆ†è¯å™¨
- `norms`: æ˜¯å¦å­˜å‚¨é•¿åº¦ä¿¡æ¯ï¼ˆå½±å“è¯„åˆ†ï¼‰
- `index_options`: æ§åˆ¶ç´¢å¼•å†…å®¹ï¼ˆdocs, freqs, positions, offsetsï¼‰

### 3. æ•°å€¼å­—æ®µå‚æ•°
- `coerce`: æ˜¯å¦å°è¯•è½¬æ¢æ•°æ®ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²è½¬æ•°å­—ï¼‰
- `ignore_malformed`: æ˜¯å¦å¿½ç•¥æ ¼å¼é”™è¯¯çš„å€¼
- `scaling_factor`: ç¼©æ”¾å› å­ï¼ˆç”¨äºscaled_floatï¼‰

### 4. æ—¥æœŸå­—æ®µå‚æ•°
- `format`: è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼ï¼ˆå¦‚"yyyy-MM-dd HH:mm:ss"ï¼‰
- `ignore_malformed`: å¿½ç•¥æ ¼å¼é”™è¯¯çš„æ—¥æœŸ

## æ˜¾å¼æ˜ å°„æœ€ä½³å®è·µ

### 1. ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨æ˜¾å¼æ˜ å°„
```json
PUT /ecommerce
{
  "mappings": {
    "properties": {
      "product_id": {"type": "keyword"},
      "product_name": {
        "type": "text",
        "analyzer": "ik_max_word",
        "fields": {
          "raw": {"type": "keyword"}
        }
      },
      "price": {"type": "scaled_float", "scaling_factor": 100},
      "created_at": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss"
      },
      "location": {"type": "geo_point"}
    }
  }
}
```

### 2. åŠ¨æ€æ¨¡æ¿ç»“åˆæ˜¾å¼æ˜ å°„
```json
PUT /logs
{
  "mappings": {
    "dynamic_templates": [
      {
        "strings_as_keywords": {
          "match_mapping_type": "string",
          "mapping": {
            "type": "keyword"
          }
        }
      }
    ],
    "properties": {
      "@timestamp": {"type": "date"},
      "message": {"type": "text"},
      "severity": {"type": "keyword"}
    }
  }
}
```

### 3. æ˜ å°„æ›´æ–°ç­–ç•¥
- **å·²æœ‰å­—æ®µæ— æ³•ä¿®æ”¹ç±»å‹**ï¼šåªèƒ½åˆ›å»ºæ–°ç´¢å¼•å¹¶é‡æ–°å¯¼å…¥æ•°æ®
- **å¯ä»¥æ·»åŠ æ–°å­—æ®µ**ï¼šä½¿ç”¨PUT mapping API
  ```json
  PUT /product/_mapping
  {
    "properties": {
      "new_field": {"type": "integer"}
    }
  }
  ```

## å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šå¦‚ä½•ä¿®æ”¹å·²æœ‰å­—æ®µç±»å‹ï¼Ÿ
**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºæ–°ç´¢å¼• â†’ å®šä¹‰æ–°æ˜ å°„ â†’ ä½¿ç”¨_reindex APIè¿ç§»æ•°æ®

```json
POST _reindex
{
  "source": {"index": "old_index"},
  "dest": {"index": "new_index"}
}
```

### é—®é¢˜2ï¼šå¦‚ä½•å¤„ç†åŠ¨æ€å­—æ®µï¼Ÿ
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨åŠ¨æ€æ¨¡æ¿æ§åˆ¶æœªçŸ¥å­—æ®µçš„è¡Œä¸º

```json
"dynamic_templates": [
  {
    "unindexed_fields": {
      "match": "*",
      "unmatch": "timestamp",
      "mapping": {
        "index": false  // ä¸ç´¢å¼•æœªçŸ¥å­—æ®µ
      }
    }
  }
]
```

### é—®é¢˜3ï¼šå¦‚ä½•ä¼˜åŒ–å¤§æ–‡æœ¬å­—æ®µï¼Ÿ
**è§£å†³æ–¹æ¡ˆ**ï¼šç¦ç”¨normså’Œdoc_values
```json
"description": {
  "type": "text",
  "norms": false,
  "doc_values": false
}
```

## æ€»ç»“

æ˜¾å¼æ˜ å°„æ˜¯ Elasticsearch æ•°æ®å»ºæ¨¡çš„æ ¸å¿ƒæŠ€èƒ½ï¼š
1. **ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œæ€§èƒ½
2. **æä¾›ç²¾ç»†æ§åˆ¶**ï¼šå­—æ®µç±»å‹ã€åˆ†è¯å™¨ã€ç´¢å¼•é€‰é¡¹ç­‰
3. **æ”¯æŒå¤æ‚æ•°æ®ç»“æ„**ï¼šå¯¹è±¡ã€åµŒå¥—ç±»å‹ã€å¤šå­—æ®µç­‰
4. **ç»“åˆåŠ¨æ€æ¨¡æ¿**ï¼šçµæ´»å¤„ç†æœªçŸ¥å­—æ®µ
5. **éœ€è¦é¢„å…ˆè§„åˆ’**ï¼šå­—æ®µç±»å‹ä¸€æ—¦è®¾ç½®æ— æ³•ç›´æ¥ä¿®æ”¹

é€šè¿‡æŒæ¡æ˜¾å¼æ˜ å°„ï¼Œæ‚¨å¯ä»¥æ„å»ºé«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ Elasticsearch æ•°æ®æ¨¡å‹ï¼Œä¸ºå„ç§æœç´¢å’Œåˆ†æåœºæ™¯æä¾›åšå®åŸºç¡€ã€‚