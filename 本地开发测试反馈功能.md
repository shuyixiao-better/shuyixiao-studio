# 本地开发测试反馈功能 🧪

## ⚠️ 重要说明

**普通的 `pnpm docs:dev` 命令无法测试反馈功能！**

因为 Netlify Functions 只在 Netlify 环境中运行，本地开发需要使用 **Netlify CLI** 模拟环境。

## 🚀 本地测试步骤

### 1. 确保已配置 .env 文件

```bash
# .env 文件内容示例
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_USER=你的163邮箱@163.com
SMTP_PASS=你的授权密码
FEEDBACK_RECEIVER=你的163邮箱@163.com
```

### 2. 使用 Netlify CLI 启动开发服务器

```bash
# 方式 1：使用 npm 脚本（推荐）
pnpm docs:dev:netlify

# 方式 2：直接使用 netlify 命令
npx netlify dev
```

### 3. 访问网站

浏览器会自动打开，或手动访问：
```
http://localhost:8888
```

**注意**：端口是 `8888`（Netlify Dev），不是 `5173`（VitePress）

### 4. 测试反馈功能

1. 点击右下角的反馈按钮
2. 填写表单内容
3. 点击"发送留言"
4. 检查邮箱是否收到邮件

## 🔄 两种开发模式对比

| 特性 | `pnpm docs:dev` | `pnpm docs:dev:netlify` |
|------|----------------|------------------------|
| 启动速度 | ⚡ 快 | 🐢 较慢 |
| 端口 | 5173 | 8888 |
| Netlify Functions | ❌ 不可用 | ✅ 可用 |
| 环境变量 | ❌ 不加载 | ✅ 自动加载 `.env` |
| 适用场景 | 日常开发 | 测试反馈功能 |

## 💡 推荐工作流程

### 日常开发（不涉及反馈功能）
```bash
pnpm docs:dev
```
- ✅ 快速启动
- ✅ 热更新流畅
- ✅ 适合写文章、调样式

### 测试反馈功能
```bash
pnpm docs:dev:netlify
```
- ✅ 完整模拟 Netlify 环境
- ✅ 可测试邮件发送
- ✅ 环境变量自动加载

## 🐛 常见问题

### Q1: 为什么 `pnpm docs:dev` 会报 404 错误？

**原因**：普通 VitePress 开发服务器不支持 Netlify Functions

**解决**：使用 `pnpm docs:dev:netlify` 或直接部署到 Netlify 测试

---

### Q2: Netlify Dev 启动很慢怎么办？

**原因**：Netlify CLI 需要初始化和检测环境

**解决**：
1. 日常开发用 `pnpm docs:dev`（快）
2. 只在测试反馈功能时用 `pnpm docs:dev:netlify`

---

### Q3: 本地测试时提示"本地开发环境不支持邮件发送"

**原因**：你仍在使用 `pnpm docs:dev`（端口 5173）

**解决**：切换到 `pnpm docs:dev:netlify`（端口 8888）

---

### Q4: Netlify Dev 提示找不到 .env 文件

**解决步骤**：
1. 确认项目根目录有 `.env` 文件
2. 确认 `.env` 文件内容格式正确
3. 重新运行 `pnpm docs:dev:netlify`

---

### Q5: 发送邮件失败，提示认证错误

**检查清单**：
- ✅ `.env` 中的 `SMTP_USER` 是你的 163 邮箱
- ✅ `SMTP_PASS` 是授权密码（不是登录密码）
- ✅ 已在 163 邮箱开启 SMTP 服务
- ✅ 授权密码正确无误

---

## 📝 Netlify CLI 配置文件

Netlify CLI 会读取项目中的 `netlify.toml` 配置：

```toml
[build]
  command = "pnpm install && pnpm run docs:build"
  publish = "docs/.vitepress/dist"

[build.environment]
  NODE_VERSION = "22"
  PNPM_VERSION = "10.17.1"

# Functions 目录（已自动识别）
[functions]
  directory = "netlify/functions"
```

## 🎯 最佳实践

### 开发流程建议

```bash
# 1. 日常写文章、改样式
pnpm docs:dev

# 2. 修改反馈功能代码后测试
pnpm docs:dev:netlify

# 3. 确认无误后提交
git add .
git commit -m "优化反馈功能"

# 4. 推送到远程仓库
git push

# 5. Netlify 自动部署并生效
```

## 🔍 调试技巧

### 查看 Netlify Functions 日志

```bash
# 启动 Netlify Dev 时会显示：
◈ Functions server is listening on 54321

# 访问反馈接口测试：
curl -X POST http://localhost:54321/.netlify/functions/feedback \
  -H "Content-Type: application/json" \
  -d '{"name":"测试","content":"测试内容"}'
```

### 查看环境变量是否加载

```javascript
// 在 netlify/functions/feedback.mjs 中添加：
console.log('Environment variables:', {
  SMTP_HOST: process.env.SMTP_HOST,
  SMTP_USER: process.env.SMTP_USER,
  // 不要打印密码！
});
```

## ✅ 测试检查清单

在提交代码前，确认以下测试通过：

- [ ] 使用 `pnpm docs:dev:netlify` 启动成功
- [ ] 点击反馈按钮，弹窗正常显示
- [ ] 填写并提交反馈，无报错
- [ ] 邮箱收到反馈邮件
- [ ] 邮件内容格式正确
- [ ] 频率限制功能正常（连续提交测试）
- [ ] 表单验证正常（空内容、错误邮箱）

## 📚 相关文档

- [Netlify CLI 文档](https://docs.netlify.com/cli/get-started/)
- [Netlify Functions 文档](https://docs.netlify.com/functions/overview/)
- [反馈功能配置指南](./用户反馈功能配置指南.md)

---

**提示**：生产环境部署后，反馈功能会自动工作，无需额外配置！

